import feedparser
import re
from malware_list_parser.plugin import Plugin

"""
Class for gleaning malware information from an arbitrary RSS data source
"""
class RssPlugin(Plugin):
	def __init__(self,rss_url,name="Rss Plugin",):
		"""Initializes using the passed in RSS feed url"""	
		super(RssPlugin,self).__init__(name=name)
		feed = feedparser.parse(rss_url)
		self._entries = self._parse_entries_from_feed(feed)
		self._description = feed["feed"]["subtitle_detail"]["value"]
    
	def _parse_entries_from_feed(self,feed):
		"""
		Returns a formatted list summarizing the latest malware available on the MDL
		"""
		entry_summaries = [re.split(",\s*",entry.summary) for entry in feed.entries]
		entry_dicts = map(
		    lambda summary : dict(map(
    		    lambda summary_line: [
    				summary_line.split(": ")[0],summary_line.split(": ")[1]
    			],
    		    [summary_line for summary_line in summary if len(summary_line.split(": ")) == 2]
    		)),
    		entry_summaries
    	)
		return entry_dicts
